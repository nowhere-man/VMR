{% extends "base.html" %}

{% block title %}{{ '编辑模板' if template_id else '创建模板' }} - VMR{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
  <div class="bg-white rounded-lg shadow-sm p-6">
    <h1 class="text-2xl font-bold text-gray-900">{{ '编辑模板' if template_id else '创建模板' }}</h1>
    <p class="mt-1 text-sm text-gray-600">配置 Baseline / Experimental。</p>
  </div>

  <form id="templateForm" class="bg-white rounded-lg shadow-sm p-6 space-y-6">
    <!-- 基本信息 -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-900">基本信息</h2>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">模板名称<span class="text-red-500">*</span></label>
        <input id="name" name="name" required maxlength="100" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
        <input id="description" name="description" maxlength="500" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
      </div>
    </div>

    <!-- Baseline -->
    <div class="space-y-4 border-t pt-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Baseline 对照组</h2>
        <label class="flex items-center text-sm text-gray-700 space-x-2">
          <input type="checkbox" id="baseline_skip" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
          <span>跳过视频编码</span>
        </label>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">源视频目录<span class="text-red-500">*</span></label>
          <input id="baseline_source_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
          <p class="text-xs text-gray-500 mt-1">YUV文件名格式需满足：stream_wxh_fps.yuv。</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">码流目录<span class="text-red-500">*</span></label>
          <input id="baseline_bitstream_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
        </div>
      </div>
      <div id="baseline_encode_block" class="space-y-4">
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器类型<span class="text-red-500">*</span></label>
            <select id="baseline_encoder_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="ffmpeg" selected>FFmpeg</option>
              <option value="x264">x264</option>
              <option value="x265">x265</option>
              <option value="vvenc">VVenC</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">RC<span class="text-red-500">*</span></label>
            <select id="baseline_rate_control" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="crf" selected>CRF</option>
              <option value="abr">ABR</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">码率点位（逗号分隔，最少4个点位）<span class="text-red-500">*</span></label>
            <input id="baseline_bitrate_points" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="如：21,24,27,29" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">编码参数<span class="text-red-500">*</span></label>
          <input id="baseline_encoder_params" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
        </div>
      </div>
    </div>

    <!-- Experimental -->
    <div class="space-y-4 border-t pt-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Experimental 实验组</h2>
        <label class="flex items-center text-sm text-gray-700 space-x-2">
          <input type="checkbox" id="exp_skip" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
          <span>跳过视频编码</span>
        </label>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">源视频目录<span class="text-red-500">*</span></label>
          <input id="exp_source_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
          <p class="text-xs text-gray-500 mt-1">YUV文件名格式需满足：stream_wxh_fps.yuv。</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">码流目录<span class="text-red-500">*</span></label>
          <input id="exp_bitstream_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
        </div>
      </div>
      <div id="exp_encode_block" class="space-y-4">
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器类型<span class="text-red-500">*</span></label>
            <select id="exp_encoder_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="ffmpeg" selected>FFmpeg</option>
              <option value="x264">x264</option>
              <option value="x265">x265</option>
              <option value="vvenc">VVenC</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">RC<span class="text-red-500">*</span></label>
            <select id="exp_rate_control" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="crf" selected>CRF</option>
              <option value="abr">ABR</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">码率点位（逗号分隔，最少4个点位）<span class="text-red-500">*</span></label>
            <input id="exp_bitrate_points" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="如：21,24,27,29" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">编码参数<span class="text-red-500">*</span></label>
          <input id="exp_encoder_params" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between pt-4 border-t">
      <div id="formError" class="text-sm text-red-600"></div>
      <div class="space-x-3">
        <a href="/templates" class="text-sm text-gray-600 hover:text-gray-900">取消</a>
        <button id="submitBtn" type="submit" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">保存模板</button>
      </div>
    </div>
  </form>
</div>

<script>
const tmplId = "{{ template_id or '' }}";
const form = document.getElementById('templateForm');
const errBox = document.getElementById('formError');
const submitBtn = document.getElementById('submitBtn');

function $(id) { return document.getElementById(id); }
const baselineSkip = $('baseline_skip');
const expSkip = $('exp_skip');
const baselineEncode = $('baseline_encode_block');
const expEncode = $('exp_encode_block');

function toggleBlocks() {
  baselineEncode.classList.toggle('hidden', baselineSkip.checked);
  expEncode.classList.toggle('hidden', expSkip.checked);
}
baselineSkip.addEventListener('change', toggleBlocks);
expSkip.addEventListener('change', toggleBlocks);
toggleBlocks();

function parsePoints(val) {
  if (!val) return [];
  return val.split(',').map(s => s.trim()).filter(Boolean).map(Number).filter(v => !Number.isNaN(v));
}

function collectSide(prefix) {
  return {
    skip_encode: $(prefix + '_skip').checked,
    source_dir: $(prefix + '_source_dir').value.trim(),
    encoder_type: $(prefix + '_encoder_type').value || null,
    encoder_params: $(prefix + '_encoder_params').value.trim() || null,
    rate_control: $(prefix + '_rate_control').value || null,
    bitrate_points: parsePoints($(prefix + '_bitrate_points').value),
    bitstream_dir: $(prefix + '_bitstream_dir').value.trim(),
  };
}

async function loadTemplate() {
  if (!tmplId) return;
  try {
    const res = await fetch(`/api/templates/${tmplId}`);
    if (!res.ok) throw new Error('加载模板失败');
    const data = await res.json();
    $('name').value = data.name || '';
    $('description').value = data.description || '';
    const fill = (prefix, side) => {
      if (!side) return;
      $(prefix + '_source_dir').value = side.source_dir || '';
      $(prefix + '_bitstream_dir').value = side.bitstream_dir || '';
      $(prefix + '_skip').checked = !!side.skip_encode;
      $(prefix + '_encoder_type').value = side.encoder_type || '';
      $(prefix + '_encoder_params').value = side.encoder_params || '';
      $(prefix + '_rate_control').value = side.rate_control || '';
      $(prefix + '_bitrate_points').value = (side.bitrate_points || []).join(',');
    };
    fill('baseline', data.baseline);
    fill('exp', data.experimental);
    toggleBlocks();
  } catch (e) {
    errBox.textContent = e.message || '加载模板失败';
  }
}
loadTemplate();

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  errBox.textContent = '';
  submitBtn.disabled = true;
  const payload = {
    name: $('name').value.trim(),
    description: $('description').value.trim() || null,
    baseline: collectSide('baseline'),
    experimental: collectSide('exp'),
  };
  const method = tmplId ? 'PUT' : 'POST';
  const url = tmplId ? `/api/templates/${tmplId}` : '/api/templates';
  try {
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.detail || '保存失败');
    window.location.href = '/templates';
  } catch (err) {
    errBox.textContent = err.message || '保存失败';
  } finally {
    submitBtn.disabled = false;
  }
});
</script>
{% endblock %}
