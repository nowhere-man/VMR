# 功能规格说明书：视频质量指标报告系统（VQMR）

**功能分支**：`001-video-quality-metrics-report`
**创建日期**：2025-10-25
**状态**：草稿
**输入**：用户描述："VQMR, Video Quality Metrics Report, 是部署在服务器上的 Web 应用。用户在本地浏览器通过 `http://<server_ip>:<port>` 访问页面，提交视频编码任务，并查看自动生成的可视化质量指标（metrics）报告。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 提交基础编码任务（优先级：P1）

视频工程师需要使用指定编码器测试单个视频文件，并查看基础质量指标以验证编码质量。

**优先级理由**：这是核心功能——没有提交任务和获取基础指标的能力，系统就无法提供任何价值。这代表了最小可行产品（MVP）。

**独立测试**：可以通过提交单个 MP4 视频文件、一个编码器和一个 ABR（平均码率）值来完整测试，然后在基础报告中查看生成的 PSNR、VMAF 和 SSIM 指标。

**验收场景**：

1. **假设** 用户访问 Web 界面，**当** 他们指定编码器路径、视频文件路径和单个 ABR 值（例如 1000 kbps），**那么** 系统接受任务并将其加入处理队列
2. **假设** 编码任务已提交，**当** 编码成功完成，**那么** 系统显示包含 PSNR、VMAF、SSIM、实际码率、编码时间和编码速度的报告
3. **假设** 用户提交的任务包含无效的编码器路径，**当** 系统验证输入时，**那么** 系统显示错误消息，指示找不到编码器
4. **假设** 用户提交的任务包含无效的视频文件路径，**当** 系统验证输入时，**那么** 系统显示错误消息，指示找不到视频文件

---

### 用户故事 2 - 对比多个码控参数（优先级：P2）

视频工程师希望对比多个码率或 CRF（恒定质量因子）值下的编码质量和性能，以找到最优的编码设置。

**优先级理由**：这实现了主要使用场景——质量对比和优化。它在 P1 基础上增加了多参数测试功能，这对于有意义的分析至关重要，但需要基础的单任务功能先正常工作。

**独立测试**：可以通过提交包含多个 ABR 值（例如 500、1000、2000 kbps）的视频进行测试，并验证报告显示所有码率下所有指标的并列对比和清晰的可视化图表。

**验收场景**：

1. **假设** 用户配置任务，**当** 他们指定多个 ABR 值（例如 500、1000、2000 kbps），**那么** 系统将每个码率作为单独的编码任务处理
2. **假设** 多个编码任务完成，**当** 用户查看报告时，**那么** 系统显示对比图表，展示每个参数值的 PSNR、VMAF、SSIM、码率、编码时间和速度
3. **假设** 用户配置任务，**当** 他们指定多个 CRF 值（例如 18、22、28），**那么** 系统将每个 CRF 值作为单独的编码任务处理
4. **假设** 用户同时选择 ABR 和 CRF 模式，**当** 他们尝试提交任务时，**那么** 系统显示错误，指示一次只能使用一种码控模式

---

### 用户故事 3 - 分析原始 YUV 视频文件（优先级：P3）

使用原始 YUV 视频源的视频工程师需要通过提供额外元数据（分辨率、像素格式、帧率）来编码和分析这些文件。

**优先级理由**：这扩展了对原始视频的输入格式支持，这在专业工作流中很常见，但属于核心功能的增强。用户仍然可以使用容器格式（P1/P2）从系统获得价值，而无需此功能。

**独立测试**：可以通过提交原始 YUV 文件并指定分辨率（1920x1080）、像素格式（yuv420p）和帧率（30fps）进行测试，然后验证成功编码和指标生成。

**验收场景**：

1. **假设** 用户选择 YUV 视频文件，**当** 他们提供分辨率、像素格式和帧率元数据时，**那么** 系统接受任务并正确处理原始视频
2. **假设** 用户选择 YUV 视频文件，**当** 他们未能提供所需元数据时，**那么** 系统显示错误，要求提供缺失的信息
3. **假设** 用户提供不正确的 YUV 元数据，**当** 由于格式不匹配导致编码失败时，**那么** 系统显示清晰的错误消息，指示元数据可能不正确

---

### 用户故事 4 - 监控逐帧性能指标（优先级：P3）

性能分析师需要了解帧级编码行为，包括逐帧延迟、CPU 利用率模式，并识别编码瓶颈。

**优先级理由**：这提供了超越基础聚合指标的高级性能洞察。对于优化工作很有价值，但对于核心的质量对比用例并非必需。

**独立测试**：可以通过提交编码任务并验证报告包含逐帧延迟图表（显示平均、最小和最大延迟）以及 CPU 利用率随时间变化的图表进行测试。

**验收场景**：

1. **假设** 编码任务完成，**当** 用户查看报告的性能部分时，**那么** 系统显示图表，展示平均逐帧延迟及其最小和最大边界
2. **假设** 编码任务完成，**当** 用户查看性能部分时，**那么** 系统显示整个编码过程中的 CPU 利用率百分比
3. **假设** 使用不同参数的多个编码任务，**当** 用户对比性能指标时，**那么** 系统显示并列的性能对比，包括延迟和 CPU 使用模式

---

### 边界情况

- 当编码器可执行文件在编码过程中崩溃时会发生什么？
- 系统如何处理超大视频文件（例如 4K、8K 分辨率）？
- 当用户多次提交相同任务时会发生什么？
- 系统如何处理包含不支持编解码器或损坏数据的视频文件？
- 当编码或指标计算期间磁盘空间耗尽时会发生什么？
- 系统如何处理超长编码任务（数小时的编码）？
- 当多个用户同时提交任务时会发生什么？
- YUV 文件在编码开始前如何验证？
- 当视频文件在任务提交后、编码开始前被删除或移动时会发生什么？
- 系统如何处理产生零字节输出文件的编码任务？

## 需求 *(必填)*

### 功能需求

- **FR-001**：系统必须提供可通过 HTTP 访问的 Web 界面，支持可配置的服务器 IP 和端口
- **FR-002**：系统必须允许用户指定视频编码器可执行文件的绝对路径
- **FR-003**：系统必须在接受任务前验证指定的编码器可执行文件存在且可执行
- **FR-004**：系统必须允许用户指定单个视频文件的绝对路径进行编码
- **FR-005**：系统必须支持视频容器格式，包括 MP4 和 FLV
- **FR-006**：系统必须在用户提供分辨率、像素格式和帧率元数据时支持原始 YUV 视频文件
- **FR-007**：系统必须在接受任务前验证指定的视频文件存在且可读
- **FR-008**：系统必须支持 ABR（平均码率，Average Bitrate）码控模式，允许用户指定目标码率（单位 kbps）
- **FR-009**：系统必须支持 CRF（恒定质量因子，Constant Rate Factor）码控模式，允许用户指定 CRF 值
- **FR-010**：系统必须允许用户为单个视频指定多个 ABR 值，将每个值作为单独的编码任务处理
- **FR-011**：系统必须允许用户为单个视频指定多个 CRF 值，将每个值作为单独的编码任务处理
- **FR-012**：系统必须阻止用户为同一任务同时选择 ABR 和 CRF 模式
- **FR-013**：系统必须执行编码任务并捕获编码器的输出日志
- **FR-014**：系统必须为每个编码视频计算 PSNR（峰值信噪比，Peak Signal-to-Noise Ratio）
- **FR-015**：系统必须为每个编码视频计算 VMAF（视频多方法评估融合，Video Multimethod Assessment Fusion）
- **FR-016**：系统必须为每个编码视频计算 SSIM（结构相似性指数，Structural Similarity Index）
- **FR-017**：系统必须测量每个编码视频的实际码率
- **FR-018**：系统必须测量每个任务的总编码时间
- **FR-019**：系统必须计算每个任务的编码速度（每秒帧数或速度倍数）
- **FR-020**：系统必须在编码过程中测量 CPU 利用率
- **FR-021**：系统必须测量逐帧编码延迟，包括平均值、最小值和最大值
- **FR-022**：系统必须生成可视化报告，以图表形式显示质量指标（PSNR、VMAF、SSIM）
- **FR-023**：系统必须生成可视化报告，以图表形式显示性能指标（码率、编码时间、编码速度、CPU 使用率）
- **FR-024**：系统必须在报告中显示逐帧延迟统计数据，包括平均值、最小值和最大值
- **FR-025**：系统必须按视频文件和码控参数组织报告数据，便于对比
- **FR-026**：系统必须在图表之外提供表格数据，以便详细检查指标
- **FR-027**：系统必须在编码任务失败时显示清晰的错误消息，说明失败原因
- **FR-028**：系统必须保留编码日志以供故障排查
- **FR-029**：系统必须向用户提供任务状态可见性（已排队、处理中、已完成、失败）
- **FR-030**：系统必须在处理多个码控参数时进行任务队列管理

### 关键实体

- **编码任务**：表示用户提交的单个编码作业，包含编码器路径、输入视频路径、码控模式（ABR 或 CRF）、码控参数值和任务状态
- **视频文件**：表示要编码的输入视频，属性包括文件路径、格式类型（容器或原始 YUV），对于 YUV 文件还包括：分辨率、像素格式和帧率
- **编码器配置**：表示编码器可执行文件及其在服务器文件系统上的位置
- **质量指标**：表示编码输出的计算视频质量测量值，包括 PSNR 值、VMAF 分数、SSIM 值和实际码率
- **性能指标**：表示编码性能测量值，包括总编码时间、编码速度（fps 或倍数）、CPU 利用率百分比、逐帧延迟统计（平均、最小、最大）
- **报告**：表示指标的可视化和呈现，按视频文件和码控参数组织数据，提供基于图表和表格的视图

## 成功标准 *(必填)*

### 可测量成果

- **SC-001**：用户可以在 1 分钟内成功提交包含一个编码器和一个码控参数的单视频编码任务
- **SC-002**：对于标准 1080p 10 秒测试视频，系统在 5 分钟内生成完整的质量指标报告（PSNR、VMAF、SSIM）
- **SC-003**：用户可以在单个报告视图中对比至少 5 个不同码控参数值的质量和性能指标
- **SC-004**：100% 的有效编码任务（编码器和视频路径正确）要么成功完成，要么失败并显示清晰、可操作的错误消息
- **SC-005**：系统准确计算所有必需指标（PSNR、VMAF、SSIM、码率、时间、速度、CPU、延迟），其值与行业标准视频分析工具的误差在 5% 以内
- **SC-006**：用户可以通过查看对比图表识别最优码控参数，无需手动导出或处理数据
- **SC-007**：系统处理至少 10 个并发编码任务而不出现任务失败或显著性能下降
- **SC-008**：90% 的用户可以在不查阅文档或寻求支持的情况下成功提交第一个编码任务
- **SC-009**：系统在任务提交前验证编码器和视频文件路径，对缺失或无效路径的错误检测率为 100%
- **SC-010**：无论测试的码控参数数量如何，报告生成在编码完成后 30 秒内完成

## 假设

- 用户指定的编码器可执行文件与系统预期的命令行接口兼容（假设：FFmpeg 兼容的命令结构）
- 用户拥有适当的文件系统权限，可以从指定路径读取视频文件和编码器可执行文件
- 服务器有足够的磁盘空间来存储原始视频、编码输出和中间指标计算文件
- 用户浏览器与 Web 服务器之间的网络带宽和延迟足以支持响应式 Web 界面交互
- YUV 像素格式值遵循标准命名约定（例如 yuv420p、yuv422p、yuv444p）
- 系统运行在具有足够 CPU 资源的服务器上，可以执行视频编码和指标计算
- 用户从启用 JavaScript 的现代 Web 浏览器访问系统
- 编码任务按顺序处理或具有可配置的并发限制，以防止资源耗尽
- VMAF 模型文件和指标计算所需的其他依赖项已预安装在服务器上
- 用户了解基本的视频编码概念（码率、CRF、质量指标），足以解读报告

## 约束

- 系统必须部署在服务器上并通过 Web 浏览器远程访问（不是桌面应用程序）
- 用户必须能够访问存储编码器和视频的文件系统（意味着服务器端文件访问）
- 每个任务只能激活一种码控模式（ABR 或 CRF）
- 初始版本仅支持单文件视频输入（不支持批量文件夹处理）
- 系统使用现有的编码器可执行文件，而不是内置编码能力
- 指标在编码完成后计算（不是在实时编码期间）
- 报告在任务完成后自动生成（不是用户单独触发）

## 依赖

- 服务器文件系统上可用的视频编码器可执行文件
- 可用的视频质量指标计算工具（用于 PSNR、VMAF、SSIM 计算）
- 可用的系统性能监控能力（CPU 利用率跟踪）
- 访问原始源视频文件以进行指标对比（质量指标需要将编码输出与原始文件对比）
- 能够处理 HTTP 请求的 Web 服务器基础设施
- 用于输入视频、编码输出、日志和报告的文件系统存储
